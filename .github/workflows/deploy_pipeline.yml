name: Deploy Pipeline

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-pipeline

jobs:
  build_application_images:
    uses: ./.github/workflows/build_application_images.yml
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      INFRA_ROLE_TO_ASSUME: ${{ secrets.INFRA_ROLE_TO_ASSUME }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      CONTRIBSYS_REPO_USERNAME: ${{ secrets.CONTRIBSYS_REPO_USERNAME }}
      CONTRIBSYS_REPO_PASSWORD: ${{ secrets.CONTRIBSYS_REPO_PASSWORD }}

  run_tests:
    uses: ./.github/workflows/run_tests.yml
    needs: build_application_images
    secrets:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      CONTRIBSYS_REPO_USERNAME: ${{ secrets.CONTRIBSYS_REPO_USERNAME }}
      CONTRIBSYS_REPO_PASSWORD: ${{ secrets.CONTRIBSYS_REPO_PASSWORD }}
      OKTA_TEST_USERNAME: ${{ secrets.OKTA_TEST_USERNAME }}
      OKTA_TEST_PASSWORD: ${{ secrets.OKTA_TEST_PASSWORD }}
      OKTA_TEST_SECRET: ${{ secrets.OKTA_TEST_SECRET }}

  deploy_dev:
    needs: run_tests
    uses: ./.github/workflows/deploy_to_environment.yml
    with:
      env: dev
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LD_CLIENT_ID: ${{ secrets.LD_CLIENT_ID }}
      OKTA_CLIENT_ID: ${{ secrets.OKTA_CLIENT_ID }}
      OKTA_SERVER_ID: ${{ secrets.OKTA_SERVER_ID }}
      STATIC_S3_BUCKET: ${{ secrets.STATIC_S3_BUCKET }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

  deploy_test:
    needs: run_tests
    uses: ./.github/workflows/deploy_to_environment.yml
    with:
      env: test
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LD_CLIENT_ID: ${{ secrets.LD_CLIENT_ID }}
      OKTA_CLIENT_ID: ${{ secrets.OKTA_CLIENT_ID }}
      OKTA_SERVER_ID: ${{ secrets.OKTA_SERVER_ID }}
      STATIC_S3_BUCKET: ${{ secrets.STATIC_S3_BUCKET }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

  deploy_impl:
    needs: [deploy_dev, deploy_test]
    uses: ./.github/workflows/deploy_to_environment.yml
    with:
      env: impl
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LD_CLIENT_ID: ${{ secrets.LD_CLIENT_ID }}
      OKTA_CLIENT_ID: ${{ secrets.OKTA_CLIENT_ID }}
      OKTA_SERVER_ID: ${{ secrets.OKTA_SERVER_ID }}
      STATIC_S3_BUCKET: ${{ secrets.STATIC_S3_BUCKET }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}

  deploy_prod:
    needs: deploy_impl
    uses: ./.github/workflows/deploy_to_environment.yml
    with:
      env: prod
    secrets:
      AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      LD_CLIENT_ID: ${{ secrets.LD_CLIENT_ID }}
      OKTA_CLIENT_ID: ${{ secrets.OKTA_CLIENT_ID }}
      OKTA_SERVER_ID: ${{ secrets.OKTA_SERVER_ID }}
      STATIC_S3_BUCKET: ${{ secrets.STATIC_S3_BUCKET }}
      ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
