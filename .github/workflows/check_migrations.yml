name: Check Migrations

# This workflow validates database migrations by:
# 1. Checking for duplicate migration version numbers
# 2. Ensuring new migrations are consecutive
# 3. Preventing modification or deletion of existing migrations (PRs only)

on:
  pull_request:
    # Run on all PRs - the script exits gracefully if no migrations changed
    # This allows the check to be required without blocking non-migration PRs
  
  # Run on merge queue events - GitHub Enterprise feature
  merge_group:
    # This runs when PR enters the merge queue
    # Tests PR against the queue's temporary branch
    # Automatically prevents race conditions!
    # Note: merge_group doesn't support paths filter, so this runs for all PRs in the queue
  
  # Also run on push to main/master to catch any issues that slip through
  push:
    branches:
      - main
      - master

# CONFIGURATION OPTIONS:
# 
# Settings → Branches → Enable "Require merge queue"
# - Automatically serializes merges
# - Runs this check in queue against latest base
# - No manual rebasing needed!
#

# Concurrency strategy:
# - For PRs: Allow parallel validation (each checks against base branch)
# - For merges to main: Serialize to prevent race conditions
concurrency:
  # Use different concurrency groups for PRs vs merges
  group: ${{ github.event_name == 'push' && 'migration-merge-lock' || format('check-migrations-{0}', github.ref) }}
  cancel-in-progress: false

jobs:
  check_migrations:
    name: Check Migration Version Numbers
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout all
        uses: actions/checkout@v5
        with:
          # Fetch full history to compare with base branch
          fetch-depth: 0
      
      - name: Run migration version validation
        run: |
          # Determine base branch for PRs and merge_group events
          BASE_BRANCH="${{ github.base_ref }}"
          
          # Default to main if base_ref is empty (for push events)
          if [ -z "$BASE_BRANCH" ]; then
            BASE_BRANCH="main"
          fi
          
          # Call the validation script with event type and base branch
          scripts/check_migration_versions.sh "${{ github.event_name }}" "$BASE_BRANCH"
      
      - name: Ensure migrations are only added (not modified or deleted)
        if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
        env:
          BASE_REF: ${{ github.event_name == 'merge_group' && github.event.merge_group.base_sha || github.base_ref }}
          HEAD_REF: ${{ github.event_name == 'merge_group' && github.event.merge_group.head_sha || github.head_ref }}
        run: |
          # For merge_group, we get SHAs instead of branch names
          if [ "${{ github.event_name }}" = "merge_group" ]; then
            # Use SHAs directly (no need for origin/ prefix)
            diff=$(git diff --name-status "${BASE_REF}..${HEAD_REF}" -- ./migrations)
          else
            # For PR, use branch names with origin/ prefix
            diff=$(git diff --name-status "origin/${BASE_REF}..origin/${HEAD_REF}" -- ./migrations)
          fi
          
          printf 'Migration diff:\n%s\n' "${diff}"
          
          diffNonAdds=$(echo "${diff}" | grep -Ev '^A' || true)
          printf 'Migration diff (non-adds):\n%s\n' "${diffNonAdds}"
          
          if [ -n "${diffNonAdds}" ]; then
            echo "Migration files can only be added in migrations folder"
            exit 1
          fi
